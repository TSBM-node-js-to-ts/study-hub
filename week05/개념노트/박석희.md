# ğŸ“˜ 7ì¥

## 7.4 ë°ì´í„°ë² ì´ìŠ¤ ë° í…Œì´ë¸” ìƒì„±í•˜ê¸°

---

### 7.4.1 ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±í•˜ê¸°

MySQL í”„ë¡¬í”„íŠ¸ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìƒì„±í•œë‹¤.

```sql
CREATE SCHEMA `nodejs`
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_general_ci;

USE nodejs;
```

- **CREATE SCHEMA**: MySQLì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” ëª…ë ¹ì–´ì´ë‹¤.
    - `SCHEMA`ì™€ `DATABASE`ëŠ” ê°™ì€ ì˜ë¯¸ë¡œ ì‚¬ìš©ëœë‹¤.
- **utf8mb4**: í•œê¸€ê³¼ ì´ëª¨ì§€ë¥¼ ëª¨ë‘ ì§€ì›í•˜ëŠ” ì¸ì½”ë”© ë°©ì‹.
- **utf8mb4_general_ci**: ë¬¸ìì—´ ì •ë ¬ ê·œì¹™(collation).

> ğŸ’¡ `utf8mb4`ë¥¼ ë°˜ë“œì‹œ ì‚¬ìš©í•´ì•¼ ì´ëª¨ì§€ ì €ì¥ì´ ê°€ëŠ¥í•˜ë‹¤.

---

### 7.4.2 í…Œì´ë¸” ìƒì„± (users, comments)

#### 1ï¸âƒ£ users í…Œì´ë¸”

```sql
CREATE TABLE nodejs.users (
  id INT NOT NULL AUTO_INCREMENT,
  name VARCHAR(20) NOT NULL,
  age INT UNSIGNED NOT NULL,
  married TINYINT NOT NULL,
  comment TEXT NULL,
  created_at DATETIME NOT NULL DEFAULT now(),
  PRIMARY KEY(id),
  UNIQUE INDEX name_UNIQUE (name ASC)
)
COMMENT = 'ì‚¬ìš©ì ì •ë³´'
ENGINE = InnoDB;
```

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| id | INT | ê¸°ë³¸í‚¤, ìë™ ì¦ê°€ |
| name | VARCHAR(20) | ì´ë¦„ (ì¤‘ë³µ ë¶ˆê°€) |
| age | INT UNSIGNED | ë‚˜ì´ (ìŒìˆ˜ ë¶ˆê°€) |
| married | TINYINT | ê²°í˜¼ ì—¬ë¶€ (0/1) |
| comment | TEXT | ìê¸°ì†Œê°œ (NULL í—ˆìš©) |
| created_at | DATETIME | ìƒì„± ì‹œê° |

í…Œì´ë¸” êµ¬ì¡° í™•ì¸:
```sql
DESC users;
```

---

#### 2ï¸âƒ£ comments í…Œì´ë¸” (ì™¸ë˜ í‚¤ í¬í•¨)

```sql
CREATE TABLE nodejs.comments (
  id INT NOT NULL AUTO_INCREMENT,
  commenter INT NOT NULL,
  comment VARCHAR(100) NOT NULL,
  created_at DATETIME NOT NULL DEFAULT now(),
  PRIMARY KEY(id),
  INDEX commenter_idx (commenter ASC),
  CONSTRAINT commenter
    FOREIGN KEY (commenter)
    REFERENCES nodejs.users (id)
    ON DELETE CASCADE
    ON UPDATE CASCADE
)
COMMENT = 'ëŒ“ê¸€'
ENGINE = InnoDB;
```

- **FOREIGN KEY (commenter)** â†’ `users.id`ë¥¼ ì°¸ì¡°.
- **ON DELETE CASCADE**: ì‚¬ìš©ìê°€ ì‚­ì œë˜ë©´ ëŒ“ê¸€ë„ ìë™ ì‚­ì œ.
- **ON UPDATE CASCADE**: `id` ë³€ê²½ ì‹œ í•¨ê»˜ ë³€ê²½ë¨.

í…Œì´ë¸” ëª©ë¡ í™•ì¸:
```sql
SHOW TABLES;
```

---

## 7.5 CRUD ì‘ì—…í•˜ê¸° (SQL)

ë°ì´í„°ë² ì´ìŠ¤ì˜ í•µì‹¬ì€ CRUD â€” **Create, Read, Update, Delete** ì´ë‹¤.

---

### 7.5.1 Create (ì‚½ì…)

```sql
INSERT INTO nodejs.users (name, age, married, comment)
VALUES ('zero', 24, 0, 'ìê¸°ì†Œê°œ1');

INSERT INTO nodejs.users (name, age, married, comment)
VALUES ('nero', 32, 1, 'ìê¸°ì†Œê°œ2');

INSERT INTO nodejs.comments (commenter, comment)
VALUES (1, 'ì•ˆë…•í•˜ì„¸ìš”. zeroì˜ ëŒ“ê¸€ì…ë‹ˆë‹¤');
```

---

### 7.5.2 Read (ì¡°íšŒ)

```sql
-- ì „ì²´ ì¡°íšŒ
SELECT * FROM nodejs.users;

-- ì¼ë¶€ ì»¬ëŸ¼
SELECT name, married FROM nodejs.users;

-- ì¡°ê±´ ì¡°íšŒ (AND)
SELECT name, age FROM nodejs.users
WHERE married = 1 AND age > 30;

-- ì¡°ê±´ ì¡°íšŒ (OR)
SELECT id, name FROM nodejs.users
WHERE married = 0 OR age > 30;

-- ì •ë ¬ (ë‚´ë¦¼ì°¨ìˆœ)
SELECT id, name FROM nodejs.users
ORDER BY age DESC;

-- ìƒìœ„ 1ê°œë§Œ
SELECT id, name FROM nodejs.users
ORDER BY age DESC
LIMIT 1;

-- 1ê°œ ê±´ë„ˆë›°ê³  ë‹¤ìŒ 1ê°œ
SELECT id, name FROM nodejs.users
ORDER BY age DESC
LIMIT 1 OFFSET 1;
```

---

### 7.5.3 Update (ìˆ˜ì •)

```sql
UPDATE nodejs.users
SET comment = 'ë°”ê¿€ ë‚´ìš©'
WHERE id = 2;
```

---

### 7.5.4 Delete (ì‚­ì œ)

```sql
DELETE FROM nodejs.users
WHERE id = 2;
```

---

## 7.6 ì‹œí€„ë¼ì´ì¦ˆ(Sequelize) ì‚¬ìš©í•˜ê¸°

ORM(Object Relational Mapping)ì€ SQLì„ ì§ì ‘ ì‘ì„±í•˜ì§€ ì•Šê³ ë„  
**ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œë¡œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì œì–´**í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.

---

### 7.6.1 ì´ˆê¸° ì„¤ì • ë° ì—°ê²°

```bash
$ npm i express morgan nunjucks sequelize sequelize-cli mysql2
$ npx sequelize init
```

**config/config.json**
```json
{
    "development": {
        "username": "root",
        "password": "ë¹„ë°€ë²ˆí˜¸",
        "database": "nodejs",
        "host": "127.0.0.1",
        "dialect": "mysql"
    }
}
```

**app.js**
```js
const express = require('express');
const morgan = require('morgan');
const nunjucks = require('nunjucks');
const { sequelize } = require('./models');

const app = express();
app.set('port', process.env.PORT || 3001);
app.set('view engine', 'html');
nunjucks.configure('views', { express: app, watch: true });

sequelize.sync({ force: false })
.then(() => console.log('DB ì—°ê²° ì„±ê³µ'))
.catch(console.error);

app.listen(app.get('port'), () => {
console.log(app.get('port'), 'ë²ˆ í¬íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘');
});
```

---

### 7.6.2 ëª¨ë¸ ì •ì˜

#### 1ï¸âƒ£ User ëª¨ë¸

```js
const Sequelize = require('sequelize');

class User extends Sequelize.Model {
static initiate(sequelize) {
    User.init({
        name: { type: Sequelize.STRING(20), allowNull: false, unique: true },
        age: { type: Sequelize.INTEGER.UNSIGNED, allowNull: false },
        married: { type: Sequelize.BOOLEAN, allowNull: false },
        comment: { type: Sequelize.TEXT, allowNull: true },
        created_at: { type: Sequelize.DATE, allowNull: false, defaultValue: Sequelize.NOW },
        }, 
        {
            sequelize,
            modelName: 'User',
            tableName: 'users',
            timestamps: false,
            charset: 'utf8',
            collate: 'utf8_general_ci',
            });
    }
}
module.exports = User;
```

#### 2ï¸âƒ£ Comment ëª¨ë¸

```js
const Sequelize = require('sequelize');

class Comment extends Sequelize.Model {
static initiate(sequelize) {
Comment.init({
comment: { type: Sequelize.STRING(100), allowNull: false },
created_at: { type: Sequelize.DATE, allowNull: true, defaultValue: Sequelize.NOW },
}, {
sequelize,
modelName: 'Comment',
tableName: 'comments',
timestamps: false,
charset: 'utf8mb4',
collate: 'utf8mb4_general_ci',
});
}
}
module.exports = Comment;
```

#### 3ï¸âƒ£ ëª¨ë¸ ë“±ë¡ (models/index.js)

```js
const Sequelize = require('sequelize');
const User = require('./user');
const Comment = require('./comment');
const config = require('../config/config.json').development;

const db = {};
const sequelize = new Sequelize(config.database, config.username, config.password, config);

db.sequelize = sequelize;
db.User = User;
db.Comment = Comment;

User.initiate(sequelize);
Comment.initiate(sequelize);

module.exports = db;
```

---

### 7.6.3 ê´€ê³„ ì„¤ì •

#### 1ï¸âƒ£ 1:N ê´€ê³„

```js
// user.js
static associate(db) {
  db.User.hasMany(db.Comment, { foreignKey: 'commenter', sourceKey: 'id' });
}

// comment.js
static associate(db) {
db.Comment.belongsTo(db.User, { foreignKey: 'commenter', targetKey: 'id' });
}
```

- í•œ ëª…ì˜ ì‚¬ìš©ì â†’ ì—¬ëŸ¬ ëŒ“ê¸€
- ëŒ“ê¸€ì€ í•œ ëª…ì˜ ì‘ì„±ìë§Œ ê°€ì§

---

### 7.6.4 CRUD ì˜ˆì‹œ (ì‹œí€„ë¼ì´ì¦ˆ ë¬¸ë²•)

#### Create
```js
await User.create({
  name: 'zero',
  age: 24,
  married: false,
  comment: 'ìê¸°ì†Œê°œ1',
});
```

#### Read
```js
const users = await User.findAll({
  attributes: ['name', 'age'],
  where: { married: false },
});
```

#### Update
```js
await User.update({ comment: 'ì—…ë°ì´íŠ¸ë¨' }, { where: { id: 1 } });
```

#### Delete
```js
await User.destroy({ where: { id: 1 } });
```

---

### 7.6.4.1 ê´€ê³„ ì¡°íšŒ (JOIN)

```js
const user = await User.findOne({
  include: [{ model: Comment }],
});
console.log(user.Comments);
```

ì¸ìŠ¤í„´ìŠ¤ ë©”ì„œë“œë¡œ ì¡°íšŒ:
```js
const user = await User.findOne({ where: { id: 1 } });
const comments = await user.getComments();
```

---

### 7.6.4.2 ì§ì ‘ ì¿¼ë¦¬ ì‹¤í–‰

```js
const [result, metadata] = await sequelize.query('SELECT * FROM users');
console.log(result);
```

---

### 7.6.5 ì „ì²´ ì‹¤í–‰ ì˜ˆì‹œ

ë¼ìš°í„°ì—ì„œ ì‚¬ìš©ì ë° ëŒ“ê¸€ CRUDë¥¼ ëª¨ë‘ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.

```js
// routes/users.js
router.get('/', async (req, res) => {
  const users = await User.findAll();
  res.json(users);
});

router.post('/', async (req, res) => {
const user = await User.create(req.body);
res.status(201).json(user);
});

router.get('/:id/comments', async (req, res) => {
const comments = await Comment.findAll({ where: { commenter: req.params.id } });
res.json(comments);
});
```

---

## ğŸ§© ì˜ë¬¸ì 
ë˜ëŠ” *Sequelizeì™€ Prismaì˜ ì°¨ì´ëŠ” ë¬´ì—‡ì¸ê°€?*
