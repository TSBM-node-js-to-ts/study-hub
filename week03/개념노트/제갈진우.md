## Node.js 패키지 생태계 이해

### 패키지 매니저 선택과 특징
- **npm**: Node.js 기본 제공, 프로젝트별 `node_modules` 생성 방식
- **Yarn**: 평탄화된 구조로 중복 최소화, 안정적인 lockfile 제공
- **pnpm**: 하드링크 기반 전역 저장소 공유, 디스크 절약과 속도 우위

**설치 방식 차이점**
- npm/Yarn: 각 프로젝트마다 패키지 복사본 저장
- pnpm: `~/.pnpm-store`에 1회 저장 후 심볼릭 링크로 참조

**프로젝트 특성별 권장사항**
- 소규모/기본 프로젝트: npm
- 모노레포/대규모 구조: pnpm
- 레거시 React 앱: Yarn v1

---

## 의존성 범주별 분류 기준

### dependencies vs devDependencies
| 구분 | 포함 대상 | 배포 환경 포함 여부 |
|------|-----------|-------------------|
| **dependencies** | 실행 시 필수 라이브러리 | ✅ 포함 |
| **devDependencies** | 빌드/테스트 도구 | ❌ 제외 |

**예시**
```json
{
  "dependencies": {
    "express": "^5.0.0"
  },
  "devDependencies": {
    "nodemon": "^3.0.0",
    "jest": "^29.0.0"
  }
}
```

### peerDependencies의 역할
- **목적**: 호스트 환경이 특정 버전을 제공한다고 가정
- **사용 사례**: React 플러그인이 사용자의 React 버전에 의존

**충돌 해결 방식**
- `npm install --legacy-peer-deps`: 경고 무시하고 진행
- `npm install --force`: 강제 설치 (권장하지 않음)
- **근본 해결**: 호환되는 버전으로 업데이트 또는 대안 라이브러리 탐색

---

## npm 핵심 명령어 활용

### 프로젝트 초기화와 패키지 관리
```bash
# 프로젝트 시작
npm init -y

# 패키지 설치
npm install lodash
npm install -D eslint

# 의존성 일괄 설치 (CI 환경)
npm ci

# 불필요한 패키지 제거
npm prune
```

### 보안과 업데이트
```bash
# 취약점 검사
npm audit

# 자동 수정 시도
npm audit fix

# 업데이트 가능 목록 확인
npm outdated
```

### npx로 일회성 실행
전역 설치 없이 CLI 도구 실행
```bash
npx create-react-app my-app
npx rimraf dist
```

---

## Express 서버 구축 흐름

### 기본 서버 설정
```javascript
const express = require('express');
const app = express();

app.set('port', process.env.PORT || 3000);

app.get('/', (req, res) => {
  res.send('Hello Express');
});

app.listen(app.get('port'), () => {
  console.log(`서버 실행 중: ${app.get('port')}`);
});
```

### 요청/응답 객체 주요 속성
**req (요청)**
- `req.query`: 쿼리스트링 파싱 결과
- `req.params`: URL 경로 매개변수
- `req.body`: POST 요청 본문 (파서 필요)

**res (응답)**
- `res.json()`: JSON 형식 응답
- `res.status(code)`: HTTP 상태 코드 설정
- `res.redirect()`: 리다이렉트 수행

---

## 미들웨어 체인 구성

### 실행 흐름 제어
```javascript
app.use((req, res, next) => {
  console.log('공통 로직');
  next(); // 다음 단계로 이동
});

app.get('/user', (req, res) => {
  res.json({ name: 'User' });
});
```

### 에러 처리 미들웨어
**매개변수 4개 필수**
```javascript
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({ error: err.message });
});
```

---

## 필수 미들웨어 설정 순서

### 1단계: 환경 설정
```javascript
require('dotenv').config();
```
- `.env` 파일로 비밀키 분리 관리

### 2단계: 로깅
```javascript
app.use(morgan('dev'));
```
- 요청 메서드/경로/응답시간 기록

### 3단계: 정적 파일
```javascript
app.use(express.static('public'));
```
- `/public` 폴더 내용을 웹에서 직접 접근 가능

### 4단계: 본문 파싱
```javascript
app.use(express.json());
app.use(express.urlencoded({ extended: false }));
```
- JSON/폼 데이터를 `req.body`로 변환

### 5단계: 쿠키와 세션
```javascript
app.use(cookieParser(process.env.SECRET));
app.use(session({
  secret: process.env.SECRET,
  resave: false,
  saveUninitialized: false
}));
```
- 쿠키 파싱 먼저, 세션 설정은 나중

---

## 파일 업로드 처리 (multer)

### 저장 규칙 정의
```javascript
const multer = require('multer');
const path = require('path');

const upload = multer({
  storage: multer.diskStorage({
    destination: (req, file, done) => {
      done(null, 'uploads/');
    },
    filename: (req, file, done) => {
      const ext = path.extname(file.originalname);
      const basename = path.basename(file.originalname, ext);
      done(null, `${basename}_${Date.now()}${ext}`);
    }
  }),
  limits: { fileSize: 5 * 1024 * 1024 } // 5MB
});
```

### 라우트에 적용
```javascript
app.post('/upload', upload.single('photo'), (req, res) => {
  console.log(req.file); // 업로드된 파일 정보
  res.send('업로드 완료');
});
```

**파일 정보 구조**
- `originalname`: 원본 파일명
- `filename`: 저장된 파일명
- `path`: 전체 경로
- `size`: 파일 크기 (바이트)

---

## 실무 체크리스트

✅ `.env` 파일을 `.gitignore`에 추가  
✅ `package-lock.json` 커밋 포함  
✅ 미들웨어 등록 순서 준수  
✅ 에러 핸들러는 최하단 배치  
✅ HTTPS 환경에서 `cookie.secure: true` 설정
